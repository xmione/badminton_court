# Dockerfile.postal
FROM ruby:2.7

ENV PATH="$PATH:/postal/bin"
ENV RAILS_ENV=production

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    libssl-dev \
    libreadline-dev \
    zlib1g-dev \
    libpq-dev \
    nodejs \
    npm \
    mariadb-client \
    redis \
    rabbitmq-server \
    netcat \
    sudo \
    dos2unix

# Clone the Postal repository
RUN git clone -b main https://github.com/postalserver/postal.git /postal
WORKDIR /postal

# Install Bundler & dependencies
RUN gem install bundler -v 2.4.22
RUN bundle _2.4.22_ install --without development test

# Create proper vendor SCSS files with required variable definitions
RUN mkdir -p /postal/app/assets/stylesheets/vendor

# Create _variables.scss using multiple echo commands
RUN echo "// Color variables" > /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$darkBlue: #1a237e;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$blue: #3949ab;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$lightBlue: #5c6bc0;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$white: #ffffff;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$gray: #9e9e9e;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$darkGray: #616161;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$lightGray: #e0e0e0;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$green: #4caf50;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$red: #f44336;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$orange: #ff9800;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "// Spacing variables" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$spacing-xs: 4px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$spacing-sm: 8px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$spacing-md: 16px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$spacing-lg: 24px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$spacing-xl: 32px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "// Font variables" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$font-size-xs: 12px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$font-size-sm: 14px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$font-size-md: 16px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$font-size-lg: 18px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$font-size-xl: 20px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "// Border radius" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$border-radius-sm: 2px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$border-radius-md: 4px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss && \
    echo "\$border-radius-lg: 8px;" >> /postal/app/assets/stylesheets/vendor/_variables.scss

# Create _bootstrap.scss using multiple echo commands
RUN echo "// Bootstrap-like styles" > /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "@import 'variables';" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo ".btn {" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  display: inline-block;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  padding: 6px 12px;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  margin-bottom: 0;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  font-size: \$font-size-sm;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  font-weight: normal;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  line-height: 1.42857143;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  text-align: center;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  white-space: nowrap;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  vertical-align: middle;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  cursor: pointer;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  background-image: none;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  border: 1px solid transparent;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  border-radius: \$border-radius-md;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  color: \$white;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  background-color: \$blue;" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  border-color: darken(\$blue, 5%);" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  &:hover {" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "    background-color: darken(\$blue, 10%);" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "    border-color: darken(\$blue, 15%);" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "  }" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss && \
    echo "}" >> /postal/app/assets/stylesheets/vendor/_bootstrap.scss

# Create a proper application.scss file that imports SCSS variables
RUN mkdir -p /postal/app/assets/stylesheets/application

RUN echo "/*" > /postal/app/assets/stylesheets/application/application.scss && \
    echo " * = require_self" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo " */" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "@import './vendor/variables';" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "// Application-specific styles" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "body {" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  font-size: \$font-size-sm;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  line-height: 1.42857143;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  color: \$darkGray;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  background-color: \$white;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  margin: 0;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  padding: 0;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "}" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo ".container {" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  margin-right: auto;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  margin-left: auto;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  padding-left: 15px;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "  padding-right: 15px;" >> /postal/app/assets/stylesheets/application/application.scss && \
    echo "}" >> /postal/app/assets/stylesheets/application/application.scss
# Ensure Postal binary is executable
RUN chmod +x /postal/bin/postal

# Create user and directories required for Postal
RUN useradd -r -m -d /postal postal && \
    mkdir -p /postal/log /var/lib/postal && \
    chown -R postal:postal /postal /var/lib/postal

# Create JavaScript directory structure and files
RUN mkdir -p /postal/app/assets/javascripts/application

# Create a basic jQuery stub file
RUN echo "// jQuery stub for Postal" > /postal/app/assets/javascripts/jquery.js && \
    echo "(function(window, undefined) {" >> /postal/app/assets/javascripts/jquery.js && \
    echo "  'use strict';" >> /postal/app/assets/javascripts/jquery.js && \
    echo "  var jQuery = function() {" >> /postal/app/assets/javascripts/jquery.js && \
    echo "    return jQuery;" >> /postal/app/assets/javascripts/jquery.js && \
    echo "  };" >> /postal/app/assets/javascripts/jquery.js && \
    echo "  window.jQuery = window.$ = jQuery;" >> /postal/app/assets/javascripts/jquery.js && \
    echo "})(window);" >> /postal/app/assets/javascripts/jquery.js

# Create application.coffee file
RUN echo "#= require jquery" > /postal/app/assets/javascripts/application/application.coffee && \
    echo "" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "#= require_self" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "# Basic application JavaScript" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "window.Postal = {} if !window.Postal" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "document.addEventListener 'DOMContentLoaded', ->" >> /postal/app/assets/javascripts/application/application.coffee && \
    echo "  console.log 'Postal application loaded'" >> /postal/app/assets/javascripts/application/application.coffee    
    
# Switch to root user temporarily for asset precompilation
USER root

# Create a basic postal configuration for precompilation
RUN mkdir -p /postal/config/postal && \
    echo "version: 2" > /postal/config/postal/postal.yml && \
    echo "web_server:" >> /postal/config/postal/postal.yml && \
    echo "  default_port: 5000" >> /postal/config/postal/postal.yml && \
    echo "  default_bind_address: 0.0.0.0" >> /postal/config/postal/postal.yml && \
    echo "  max_threads: 5" >> /postal/config/postal/postal.yml && \
    echo "main_db:" >> /postal/config/postal/postal.yml && \
    echo "  host: localhost" >> /postal/config/postal/postal.yml && \
    echo "  port: 3306" >> /postal/config/postal/postal.yml && \
    echo "  username: postal" >> /postal/config/postal/postal.yml && \
    echo "  password: postal" >> /postal/config/postal/postal.yml && \
    echo "  database: postal" >> /postal/config/postal/postal.yml && \
    echo "rails:" >> /postal/config/postal/postal.yml && \
    echo "  environment: production" >> /postal/config/postal/postal.yml && \
    echo "  secret_key: $(openssl rand -base64 32)" >> /postal/config/postal/postal.yml

# Precompile assets
RUN bundle exec rake assets:clean assets:precompile

# Switch back to postal user
USER postal
WORKDIR /postal/config/postal

WORKDIR /postal

# Copy the Postal configuration template
COPY postal.yml.erb config/postal/postal.yml.erb

# Copy the scripts
COPY entrypoint.sh /postal/entrypoint.sh
COPY start-postal.sh /postal/start-postal.sh

# Convert scripts to Unix format and make them executable
USER root
RUN dos2unix /postal/entrypoint.sh /postal/start-postal.sh && \
    chmod +x /postal/entrypoint.sh /postal/start-postal.sh

# Ensure correct ownership
RUN chown -R postal:postal /postal/config
RUN chown postal:postal /postal/entrypoint.sh /postal/start-postal.sh

USER postal

EXPOSE 5000 25 587 465 

# Set the entrypoint to handle environment setup
ENTRYPOINT ["/postal/entrypoint.sh"]

# Set the command to your automation script
CMD ["/postal/start-postal.sh"]