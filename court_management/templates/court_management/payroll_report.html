{% extends 'court_management/base.html' %}
{% load custom_filters %}

{% block title %}Payroll Report - Badminton Court Management{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-10">
        <h1>Payroll Report - {{ month_name }} {{ year }}</h1>
    </div>
    <div class="col-md-2 text-end">
        <a href="{% url 'index' %}" class="btn btn-secondary">
            <i class="bi bi-house"></i> Home
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="btn-group" role="group">
                    <a href="{% url 'payroll-report-month' prev_year prev_month %}" class="btn btn-outline-primary">
                        <i class="bi bi-chevron-left"></i> Previous Month
                    </a>
                    <a href="{% url 'payroll-report-month' next_year next_month %}" class="btn btn-outline-primary">
                        Next Month <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <h4>Total Payroll: ${{ total_payroll|floatformat:2 }}</h4>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Position</th>
                        <th>Hourly Rate</th>
                        <th>Hours Worked</th>
                        <th>Total Pay</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in employee_data %}
                        <tr>
                            <td>{{ data.employee.name }}</td>
                            <td>{{ data.employee.get_position_display }}</td>
                            <td>${{ data.employee.hourly_rate }}</td>
                            <td>{{ data.total_hours|floatformat:1 }}</td>
                            <td>${{ data.total_pay|floatformat:2 }}</td>
                            <td>
                                <a href="{% url 'employee-detail' data.employee.pk %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> View
                                </a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No payroll data available for this month.</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3">Total</th>
                        <th>{{ employee_data|sum_attribute:'total_hours'|floatformat:1 }}</th>
                        <th>${{ total_payroll|floatformat:2 }}</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="row mt-4">
    {% for data in employee_data %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h4>{{ data.employee.name }} - Time Entries</h4>
                </div>
                <div class="card-body">
                    {% if data.time_entries %}
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Clock In</th>
                                        <th>Clock Out</th>
                                        <th>Hours</th>
                                        <th>Pay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in data.time_entries %}
                                        <tr>
                                            <td>{{ entry.clock_in|date:"Y-m-d" }}</td>
                                            <td>{{ entry.clock_in|date:"H:i" }}</td>
                                            <td>{{ entry.clock_out|date:"H:i"|default:"-" }}</td>
                                            <td>{{ entry.duration_hours|floatformat:1 }}</td>
                                            <td>${{ entry.calculate_pay|floatformat:2 }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p>No time entries for this employee this month.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% endblock %}